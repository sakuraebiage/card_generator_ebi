<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>歳神巡幸祭カードジェネレーター</title>
<style>
body {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #f9f0e6;
  font-family: "serif";
}
canvas {
  border: 1px solid #ccc;
  margin-top: 20px;
}
.form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 20px;
  width: 800px;
}
.form-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.form-row label {
  width: 120px;
  font-weight: bold;
}
.form-row input[type="text"],
.form-row textarea {
  flex: 1;
}
.form-row select {
  flex: 0 0 180px;
}
.form-row input[type="number"] {
  width: 60px;
}

/* ===== フォント読み込み ===== */
@font-face {
  font-family: 'AnHina02';
  src: url('fonts/AnHina02.otf') format('opentype');
}
@font-face {
  font-family: 'MSMincho';
  src: url('fonts/MSMINCHO.TTC') format('truetype-collection');
}
@font-face {
  font-family: 'YorutegakiBold';
  src: url('fonts/YorutegakiBold.otf') format('opentype');
}
@font-face {
  font-family: 'YorutegakiLight';
  src: url('fonts/YorutegakiLight.otf') format('opentype');
}
@font-face {
  font-family: 'YorutegakiRegular';
  src: url('fonts/YorutegakiRegular.otf') format('opentype');
}
@font-face {
  font-family: 'AoyagiKouzanT';
  src: url('fonts/青柳衡山フォントT.ttf') format('truetype');
}
</style>
</head>
<body>
<h2>歳神巡幸祭カードジェネレーター</h2>
<div class="form">

<!-- NAME -->
<div class="form-row">
  <label>NAME:</label>
  <input type="text" id="name" maxlength="20">
  <select id="fontName">
    <option value="serif">Serif</option>
    <option value="sans-serif">Sans-serif</option>
    <option value="YorutegakiRegular">YorutegakiRegular</option>
    <option value="YorutegakiLight">YorutegakiLight</option>
    <option value="YorutegakiBold">YorutegakiBold</option>
    <option value="AnHina02">AnHina02</option>
    <option value="MSMincho">MS Mincho</option>
    <option value="AoyagiKouzanT">青柳衡山フォント</option>
  </select>
  <input type="number" id="sizeName" value="48">
</div>

<!-- CAST -->
<div class="form-row">
  <label>CAST:</label>
  <input type="text" id="cast" maxlength="50">
  <select id="fontCast">
    <option value="serif">Serif</option>
    <option value="sans-serif">Sans-serif</option>
    <option value="YorutegakiRegular">YorutegakiRegular</option>
    <option value="YorutegakiLight">YorutegakiLight</option>
    <option value="YorutegakiBold">YorutegakiBold</option>
    <option value="AnHina02">AnHina02</option>
    <option value="MSMincho">MS Mincho</option>
    <option value="AoyagiKouzanT">青柳衡山フォント</option>
  </select>
  <input type="number" id="sizeCast" value="36">
  
</div>
  <label>役職を選択（複数選択可）:</label>
    <div id="roleContainer">
   <label><input type="checkbox" name="role" value="後見人"> 後見人</label>
    <label><input type="checkbox" name="role" value="露店出店者"> 露店出店者</label>
    <label><input type="checkbox" name="role" value="縁者"> 縁者</label>
    <label><input type="checkbox" name="role" value="観客"> 観客</label>
    <label><input type="checkbox" name="role" value="見学"> 見学</label>
    <label><input type="checkbox" name="role" value="主催"> 主催</label>
    <label><input type="checkbox" name="role" value="運営"> 運営</label>
    <label><input type="checkbox" name="role" value="斎人"> 斎人</label>
</div>


<!-- ひとこと -->
<div class="form-row">
  <label>ひとこと:</label>
  <input type="text" id="comment1" maxlength="16">
  <select id="fontComment1">
    <option value="serif">Serif</option>
    <option value="YorutegakiRegular">YorutegakiRegular</option>
    <option value="YorutegakiLight">YorutegakiLight</option>
    <option value="YorutegakiBold">YorutegakiBold</option>
    <option value="AnHina02">AnHina02</option>
    <option value="MSMincho">MS Mincho</option>
    <option value="AoyagiKouzanT">青柳衡山フォント</option>
  </select>
  <input type="number" id="sizeComment1" value="26">
</div>

<!-- 自己紹介 -->
<div class="form-row">
  <label>自己紹介:</label>
  <textarea id="comment2" maxlength="120" rows="2"></textarea>
  <select id="fontComment2">
    <option value="serif">Serif</option>
    <option value="YorutegakiRegular">YorutegakiRegular</option>
    <option value="YorutegakiLight">YorutegakiLight</option>
    <option value="YorutegakiBold">YorutegakiBold</option>
    <option value="AnHina02">AnHina02</option>
    <option value="MSMincho">MS Mincho</option>
    <option value="AoyagiKouzanT">青柳衡山フォント</option>
  </select>
  <input type="number" id="sizeComment2" value="28">
</div>

<!-- 背景画像 -->
<div class="form-row">
  <label>背景画像:</label>
  <select id="bgSelector">
    <option value="none">--- 選択してください ---</option>
    <option value="緑.png">緑</option>
    <option value="青.png">青</option>
    <option value="橙.png">橙</option>
  </select>
</div>

<!-- イラストアップロード -->
<div class="form-row">
  <label>イラスト　画像サイズ700*800:</label>
  <input type="file" id="imageUpload" accept="image/*">
</div>

<button onclick="downloadImage()">画像を保存</button>
</div>

<canvas id="cardCanvas" width="1400" height="933"></canvas>

<script>
const canvas = document.getElementById("cardCanvas");
const ctx = canvas.getContext("2d");
const template = new Image();
template.src = "サンプル2.png";

let charaImg = null;
let bgImage = null;

// --- 入力項目リスト ---
const fields = ["name","cast","comment1","comment2"];
const fontFields = ["fontName","fontCast","fontComment1","fontComment2"];
const sizeFields = ["sizeName","sizeCast","sizeComment1","sizeComment2"];

// --- 保存処理 ---
function saveToStorage(){
  fields.concat(fontFields).concat(sizeFields).forEach(id=>{
    localStorage.setItem(id, document.getElementById(id).value);
  });
  localStorage.setItem("bgSelector", document.getElementById("bgSelector").value);
}

// --- 復元処理 ---
function loadFromStorage(){
  fields.concat(fontFields).concat(sizeFields).forEach(id=>{
    if(localStorage.getItem(id)){
      document.getElementById(id).value = localStorage.getItem(id);
    }
  });
  if(localStorage.getItem("bgSelector")){
    document.getElementById("bgSelector").value = localStorage.getItem("bgSelector");
    if(document.getElementById("bgSelector").value !== "none"){
      bgImage = new Image();
      bgImage.onload = draw;
      bgImage.src = `images/${document.getElementById("bgSelector").value}`;
    }
  }
}

template.onload = function(){
  loadFromStorage();
  draw();
};

// --- 入力即時反映 ---
[...fields, ...fontFields, ...sizeFields].forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>{ saveToStorage(); draw(); });
  document.getElementById(id).addEventListener("change", ()=>{ saveToStorage(); draw(); });
});

document.getElementById("bgSelector").addEventListener("change", function(){
  saveToStorage();
  if(this.value==="none"){ bgImage=null; draw(); }
  else { bgImage=new Image(); bgImage.onload=draw; bgImage.src=`images/${this.value}`; }
});

document.getElementById("imageUpload").addEventListener("change", function(e){
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=function(evt){
      charaImg=new Image();
      charaImg.onload=draw;
      charaImg.src=evt.target.result;
    }
    reader.readAsDataURL(file);
  }
});

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(template,0,0,canvas.width,canvas.height);
  if(bgImage) ctx.drawImage(bgImage,143,185,385,475);
  if(charaImg) ctx.drawImage(charaImg,140,180,390,497);

  // NAME
  const nameText=document.getElementById("name").value;
  ctx.font=`bold ${document.getElementById("sizeName").value}px "${document.getElementById("fontName").value}"`;
  ctx.fillStyle="black";
  ctx.textAlign="left";
  ctx.fillText(nameText,710,250);

  // CAST
  const castText=document.getElementById("cast").value;
  ctx.font=`bold ${document.getElementById("sizeCast").value}px "${document.getElementById("fontCast").value}"`;
  ctx.fillText(castText,660,390);

  // ひとこと
  const c1=document.getElementById("comment1").value;
  ctx.font=`bold ${document.getElementById("sizeComment1").value}px "${document.getElementById("fontComment1").value}"`;
  ctx.fillText("「"+c1+"」",780,660);

  // 自己紹介（自動改行）
  const c2=document.getElementById("comment2").value;
  ctx.font=`${document.getElementById("sizeComment2").value}px "${document.getElementById("fontComment2").value}"`;
  drawMultilineText(ctx,c2,600,700,650,32,40);
}

function drawMultilineText(ctx,text,x,y,maxWidth,lineHeight,maxChars){
  const lines=text.match(new RegExp(`.{1,${maxChars}}`,"g"))||[];
  lines.forEach((line,i)=> ctx.fillText(line,x,y+i*lineHeight));
}
  function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(template, 0, 0, canvas.width, canvas.height);

      if (bgImage) ctx.drawImage(bgImage, 143, 185, 385, 475);
      if (charaImg) ctx.drawImage(charaImg, 140, 180, 390, 497);

      ctx.font = "bold 48px serif";
      ctx.fillStyle = "black";
      ctx.textAlign = "left";
      ctx.fillText(document.getElementById("name").value, 710, 250);
      ctx.fillText(document.getElementById("cast").value, 710, 390);

      const rolePositionMap = {
        "後見人": { x: 755, y: 450, w: 96, h: 34 },
        "露店出店者": { x: 960, y: 450, w: 170, h: 34 },
        "縁者": { x: 740, y: 500, w: 72, h: 34 },
        "観客": { x: 955, y: 505, w: 72, h: 34 },
        "見学": { x: 1125, y: 510, w: 72, h: 34 },
        "主催": { x: 745, y: 550, w: 72, h: 34 },
        "運営": { x: 950, y: 550, w: 72, h: 34 },
        "斎人": { x: 1125, y: 550, w: 72, h: 34 },
      };
      const selectedRoles = Array.from(document.querySelectorAll("input[name='role']:checked"))
                                .map(cb => cb.value);

function downloadImage(){
  const link=document.createElement('a');
  link.download='card.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
}
</script>
</body>
</html>

