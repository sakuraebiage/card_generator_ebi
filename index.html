<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>歳神巡幸祭カードジェネレーター</title>
<style>
body {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #f9f0e6;
}
canvas {
  border: 1px solid #ccc;
  margin-top: 20px;
}
.form {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 20px;
  width: 300px;
}
label { font-weight: bold; }
input[type="text"], select, textarea { width: 100%; }
</style>

<!-- フォント読み込み -->
<style>
@font-face { font-family: 'AoyagiKozan'; src: url('fonts/AoyagiKozan.ttf') format('truetype'); font-display: swap; }
@font-face { font-family: 'YorutegakiLight'; src: url('fonts/YorutegakiLight.otf') format('opentype'); font-display: swap; }
@font-face { font-family: 'YorutegakiRegular'; src: url('fonts/YorutegakiRegular.otf') format('opentype'); font-display: swap; }
@font-face { font-family: 'AnHina02'; src: url('fonts/AnHina02.otf') format('opentype'); font-display: swap; }
</style>
</head>
<body>
<h2>歳神巡幸祭カードジェネレーター</h2>
<div class="form">
  <label>NAME:</label>
  <input type="text" id="name" maxlength="20">
  <select id="fontName">
    <option value="serif">標準</option>
    <option value="AoyagiKozan">青柳衡山</option>
    <option value="YorutegakiLight">Yoru手書きLight</option>
    <option value="YorutegakiRegular">Yoru手書きRegular</option>
    <option value="AnHina02">AnHina02</option>
  </select>

  <label>CAST:</label>
  <input type="text" id="cast" maxlength="50">
  <select id="fontCast">
    <option value="serif">標準</option>
    <option value="AoyagiKozan">青柳衡山</option>
    <option value="YorutegakiLight">Yoru手書きLight</option>
    <option value="YorutegakiRegular">Yoru手書きRegular</option>
    <option value="AnHina02">AnHina02</option>
  </select>

  <label>ひとこと（16文字以内）:</label>
  <input type="text" id="comment1" maxlength="16">
  <select id="fontComment1">
    <option value="serif">標準</option>
    <option value="AoyagiKozan">青柳衡山</option>
    <option value="YorutegakiLight">Yoru手書きLight</option>
    <option value="YorutegakiRegular">Yoru手書きRegular</option>
    <option value="AnHina02">AnHina02</option>
  </select>

  <label>自己紹介（120文字以内）:</label>
  <textarea id="comment2" maxlength="120" rows="3"></textarea>
  <select id="fontComment2">
    <option value="serif">標準</option>
    <option value="AoyagiKozan">青柳衡山</option>
    <option value="YorutegakiLight">Yoru手書きLight</option>
    <option value="YorutegakiRegular">Yoru手書きRegular</option>
    <option value="AnHina02">AnHina02</option>
  </select>

  <label>背景画像を選択:</label>
  <select id="bgSelector">
    <option value="none">--- 選択してください ---</option>
    <option value="緑.png">緑</option>
    <option value="青.png">青</option>
    <option value="橙.png">橙</option>
  </select>

  <label>イラスト画像をアップロード（バストアップ700*800）:</label>
  <input type="file" id="imageUpload" accept="image/*">

  <button onclick="downloadImage()">画像を保存</button>
</div>

<canvas id="cardCanvas" width="1400" height="933"></canvas>

<script>
const canvas = document.getElementById("cardCanvas");
const ctx = canvas.getContext("2d");
const template = new Image();
template.src = "サンプル2.png";
let charaImg = null;
let bgImage = null;

// イベント
document.querySelectorAll("#name,#cast,#comment1,#comment2").forEach(el => el.addEventListener("input", draw));
document.querySelectorAll("input[name='role']").forEach(cb => cb.addEventListener("change", draw));
document.getElementById("imageUpload").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = event => {
    const img = new Image();
    img.onload = () => {
      const scale = Math.min(390/img.width,480/img.height);
      const w = img.width*scale;
      const h = img.height*scale;
      const off = document.createElement("canvas");
      off.width=390; off.height=480;
      const offCtx = off.getContext("2d");
      offCtx.drawImage(img,(390-w)/2,(480-h)/2,w,h);
      charaImg = new Image();
      charaImg.onload=draw;
      charaImg.src = off.toDataURL();
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(e.target.files[0]);
});

document.getElementById("bgSelector").addEventListener("change", function() {
  if(this.value==="none"){ bgImage=null; draw(); }
  else{ bgImage = new Image(); bgImage.onload=draw; bgImage.src=`images/${this.value}`; }
});

// フォント読み込み完了後に描画
document.fonts.ready.then(draw);

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(template,0,0,canvas.width,canvas.height);
  if(bgImage) ctx.drawImage(bgImage,143,185,385,475);
  if(charaImg) ctx.drawImage(charaImg,140,180,390,497);

  // NAME
  ctx.font = `bold 48px ${document.getElementById("fontName").value}`;
  ctx.fillStyle = "black";
  ctx.textAlign = "left";
  ctx.fillText(document.getElementById("name").value,710,250);

  // CAST 自動サイズ
  let castText = document.getElementById("cast").value;
  let fontSize = 40;
  do {
    ctx.font = `bold ${fontSize}px ${document.getElementById("fontCast").value}`;
    fontSize--;
  } while(ctx.measureText(castText).width>650 && fontSize>12);
  ctx.fillText(castText,710,390);

  // ひとこと
  ctx.font = `bold 26px ${document.getElementById("fontComment1").value}`;
  ctx.fillText("「"+document.getElementById("comment1").value+"」",780,660);

  // 自己紹介 40文字で改行
  ctx.font = `30px ${document.getElementById("fontComment2").value}`;
  drawMultilineText(ctx,document.getElementById("comment2").value,600,700,40,34);
}

// 自動改行関数
function drawMultilineText(ctx,text,x,y,charsPerLine,lineHeight){
  const lines = text.match(new RegExp(".{1,"+charsPerLine+"}","g"))||[];
  lines.forEach((line,i)=>ctx.fillText(line,x,y+i*lineHeight));
}

// 画像保存
function downloadImage(){
  const link=document.createElement('a');
  link.download='card.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
}
</script>
</body>
</html>

